name: Production DB Migration

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: Type "migrate-production" to run production migrations
        required: true
        type: string

jobs:
  migrate:
    name: Run production migrations
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    permissions:
      contents: read
    concurrency:
      group: production-db-migration
      cancel-in-progress: false
    env:
      TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
      TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
    steps:
      - name: Validate confirmation input
        shell: bash
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "migrate-production" ]; then
            echo "Invalid confirmation input."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run migrations
        working-directory: packages/web
        run: bun drizzle-kit migrate
