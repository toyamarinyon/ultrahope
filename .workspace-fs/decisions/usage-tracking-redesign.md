# Usage Tracking Redesign

## Background

### Current State (as-is)

The `freePlanDailyUsage` table tracks API usage per user per day. The `incrementDailyUsage()` function is called every time the `translate()` API is invoked.

**Problem**: When a CLI command like `ultrahope jj describe` or `ultrahope git commit` is executed, it calls the translate API 4 times (once per model in `DEFAULT_MODELS`). This results in the daily usage count incrementing by 4, even though the user only ran one command.

**Files involved**:
- `packages/web/src/lib/daily-limit.ts` - `incrementDailyUsage()` called per API request
- `packages/web/src/lib/llm/index.ts` - calls `incrementDailyUsage()` in `after()` hook
- `packages/cli/src/lib/vcs-message-generator.ts` - calls API 4 times in parallel with different models

### Desired State (to-be)

Daily usage should be counted **per CLI command execution**, not per API request. Running `ultrahope jj describe` once should count as 1 usage, regardless of how many models are queried.

## Proposed Solution

Instead of the current `freePlanDailyUsage` table, create two new tables for better observability and flexible usage tracking:

### New Tables

1. **`command_execution`** - Records each CLI command execution
   - `id` (PK)
   - `cliSessionId` - UUID generated by CLI at command start (currently same as id)
   - `userId` - Foreign key to user
   - `command` - The CLI command executed (e.g., "jj describe", "git commit", "translate")
   - `args` - CLI arguments passed to the command
   - `api` - API endpoint hit (e.g., "/v1/translate")
   - `requestPayload` - Request body sent to `/v1/translate` (TEXT JSON)
   - `startedAt` - Timestamp
   - `finishedAt` - Timestamp (nullable)

2. **`generation`** - Records each individual model generation
   - `id` (PK)
   - `commandExecutionId` - Foreign key to command_execution
   - `vercelAiGatewayGenerationId` - Unique ID from Vercel AI Gateway
   - `model` - Model used
   - `providerName` - Provider used
   - `cost` - Cost in microdollars
   - `latency` - Request latency
   - `createdAt` - Timestamp
   - `gatewayPayload` - Raw JSON from Vercel Generation Lookup (TEXT JSON)
   - `output` - LLM output (stored for command history)

### Benefits

- **Plan-agnostic tracking**: All usage is recorded regardless of plan
- **Observability**: Can analyze usage patterns, popular models, costs per command
- **Flexible limits**: Free plan limit can be checked by counting `command_execution` in last 24 hours (sliding window)
- **Persistent**: No in-memory cache needed; survives server restarts

### Implementation Flow

1. CLI generates `commandExecutionId` (UUID) at command start and uses the same value as `cliSessionId`.
2. CLI sends `/v1/command_execution` and `/v1/translate` in parallel.
3. `/v1/command_execution`:
   - Checks free plan limit by counting `command_execution` in the last 24 hours (sliding window).
   - Inserts the `command_execution` row with `requestPayload`.
4. `/v1/translate`:
   - Starts generation immediately.
   - If `/v1/command_execution` returns `daily_limit_exceeded`, the CLI aborts `/v1/translate`.
   - For Pro users, credit balance is checked here (current behavior).
   - Persists a `generation` row with `output`.

Free plan check: `SELECT COUNT(*) FROM command_execution WHERE userId = ? AND startedAt > NOW() - INTERVAL 24 HOUR`

## Tasks

- [ ] Design and create `command_execution` table schema
- [ ] Design and create `generation` table schema
- [ ] Add `/v1/command_execution` endpoint and request body schema
- [ ] Add `commandExecutionId` to `/v1/translate` request body schema
- [ ] Implement command_execution recording logic in API (free plan check)
- [ ] Implement generation recording logic (store output)
- [ ] Update free plan limit check to use `command_execution` count
- [ ] Update CLI to generate and send `commandExecutionId` / `cliSessionId`
- [ ] Migrate or deprecate `freePlanDailyUsage` table
- [ ] Add tests for new usage tracking

## Related Files

- `packages/web/src/db/schema.ts` - Database schema
- `packages/web/src/lib/daily-limit.ts` - Current daily limit logic
- `packages/web/src/lib/llm/index.ts` - API translate function
- `packages/web/src/lib/api.ts` - API endpoint definitions
- `packages/cli/src/lib/vcs-message-generator.ts` - CLI message generation
- `packages/cli/src/commands/translate.ts` - CLI translate command
