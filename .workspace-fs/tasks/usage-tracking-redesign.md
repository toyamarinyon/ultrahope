# Usage Tracking Redesign

## Background

### Current State (as-is)

The `freePlanDailyUsage` table tracks API usage per user per day. The `incrementDailyUsage()` function is called every time the `translate()` API is invoked.

**Problem**: When a CLI command like `ultrahope jj describe` or `ultrahope git commit` is executed, it calls the translate API 4 times (once per model in `DEFAULT_MODELS`). This results in the daily usage count incrementing by 4, even though the user only ran one command.

**Files involved**:
- `packages/web/src/lib/daily-limit.ts` - `incrementDailyUsage()` called per API request
- `packages/web/src/lib/llm/index.ts` - calls `incrementDailyUsage()` in `after()` hook
- `packages/cli/src/lib/vcs-message-generator.ts` - calls API 4 times in parallel with different models

### Desired State (to-be)

Daily usage should be counted **per CLI command execution**, not per API request. Running `ultrahope jj describe` once should count as 1 usage, regardless of how many models are queried.

## Proposed Solution

Instead of the current `freePlanDailyUsage` table, create two new tables for better observability and flexible usage tracking:

### New Tables

1. **`cli_sessions`** - Records each CLI command execution
   - `sessionId` (PK) - UUID generated by CLI at command start
   - `userId` - Foreign key to user
   - `command` - The CLI command executed (e.g., "jj describe", "git commit", "translate")
   - `createdAt` - Timestamp

2. **`api_requests`** - Records each individual API request
   - `id` (PK)
   - `sessionId` - Foreign key to cli_sessions (nullable for non-CLI requests)
   - `model` - Model used
   - `inputTokens` - Token usage
   - `outputTokens` - Token usage
   - `cost` - Cost in microdollars
   - `createdAt` - Timestamp

### Benefits

- **Plan-agnostic tracking**: All usage is recorded regardless of plan
- **Observability**: Can analyze usage patterns, popular models, costs per command
- **Flexible limits**: Free plan limit can be checked by counting `cli_sessions` in last 24 hours (sliding window)
- **Persistent**: No in-memory cache needed; survives server restarts

### Implementation Flow

1. CLI generates `sessionId` (UUID) at command start
2. CLI includes `sessionId` in all API requests for that command
3. API records session in `cli_sessions` on first request with that `sessionId`
4. API records each request in `api_requests` with the `sessionId`
5. Free plan check: `SELECT COUNT(*) FROM cli_sessions WHERE userId = ? AND createdAt > NOW() - INTERVAL 24 HOUR`

## Tasks

- [ ] Design and create `cli_sessions` table schema
- [ ] Design and create `api_requests` table schema
- [ ] Add `sessionId` to API request body schema
- [ ] Implement session recording logic in API
- [ ] Implement API request recording logic
- [ ] Update free plan limit check to use `cli_sessions` count
- [ ] Update CLI to generate and send `sessionId`
- [ ] Migrate or deprecate `freePlanDailyUsage` table
- [ ] Add tests for new usage tracking

## Related Files

- `packages/web/src/db/schema.ts` - Database schema
- `packages/web/src/lib/daily-limit.ts` - Current daily limit logic
- `packages/web/src/lib/llm/index.ts` - API translate function
- `packages/web/src/lib/api.ts` - API endpoint definitions
- `packages/cli/src/lib/vcs-message-generator.ts` - CLI message generation
- `packages/cli/src/commands/translate.ts` - CLI translate command
